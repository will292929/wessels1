<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile Frame Generator</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #0b1020; color: #fff; }
    .wrap { max-width: 820px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; }
    h1 { margin: 0 0 10px; font-size: 18px; font-weight: 700; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; }
    .left { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .small { font-size: 13px; opacity: 0.85; line-height: 1.35; }
    .error { font-size: 13px; color: #ffb4b4; white-space: pre-wrap; margin-top: 10px; }
    canvas { width: 100%; max-width: 560px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); }

    input[type="file"] { color: #fff; }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 650;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Customer-friendly toggle */
    .toggleWrap { display: flex; flex-direction: column; gap: 6px; }
    .toggleRow { display: inline-flex; align-items: center; gap: 10px; user-select: none; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); opacity: 0.9; }
    .pill.on { opacity: 1; border-color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.12); }
    .toggle {
      position: relative;
      width: 58px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      cursor: pointer;
      flex: 0 0 auto;
    }
    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #fff;
      transition: transform 160ms ease;
    }
    .toggle[data-on="true"] .knob { transform: translateX(28px); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Profile Frame Generator</h1>

      <div class="row">
        <div class="left">
          <div>
            <div class="small">Upload photo</div>
            <input id="file" type="file" accept="image/*" />
          </div>

          <div class="toggleWrap">
            <div class="small">Frame style</div>
            <div class="toggleRow" id="modeSwitch" title="Switch frame style">
              <span class="pill on" id="labelCircle">Circle</span>
              <div class="toggle" id="toggle" data-on="false" role="switch" aria-checked="false">
                <div class="knob"></div>
              </div>
              <span class="pill" id="labelCorner">Corner</span>
            </div>
          </div>
        </div>

        <button id="download" class="btn" disabled>Download PNG</button>
      </div>

      <div class="small" style="margin-top: 12px;">
        Please keep these files in the same folder as this page:
        <span class="pill">bg.jpg</span>
        <span class="pill">circle.png</span>
        <span class="pill">corner.jpg</span>
        <span class="pill">logo.png</span>
      </div>

      <div id="status" class="small" style="margin-top: 10px;"></div>
      <div id="err" class="error"></div>
    </div>

    <div class="card">
      <div class="small" style="margin-bottom: 10px;">Preview</div>
      <canvas id="c" width="1080" height="1080"></canvas>
    </div>
  </div>

  <script>
    (() => {
      const SIZE = 1080;

      const elFile = document.getElementById("file");
      const elDownload = document.getElementById("download");
      const elStatus = document.getElementById("status");
      const elErr = document.getElementById("err");

      const modeSwitch = document.getElementById("modeSwitch");
      const toggle = document.getElementById("toggle");
      const labelCircle = document.getElementById("labelCircle");
      const labelCorner = document.getElementById("labelCorner");

      const canvas = document.getElementById("c");
      const ctx = canvas.getContext("2d");

      let userImg = null;
      let lastBlobUrl = null;

      // Cache assets (avoids reloading each render)
      const cache = new Map();
      async function loadImage(src) {
        if (cache.has(src)) return cache.get(src);
        const p = new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error(`Could not load "${src}". Please make sure it is in the same folder as this page.`));
          img.src = src;
        });
        cache.set(src, p);
        return p;
      }

      const setError = (msg) => (elErr.textContent = msg || "");
      const setStatus = (msg) => (elStatus.textContent = msg || "");

      function getMode() {
        return toggle.dataset.on === "true" ? "corner" : "circle";
      }

      function setMode(mode) {
        const on = mode === "corner";
        toggle.dataset.on = on ? "true" : "false";
        toggle.setAttribute("aria-checked", on ? "true" : "false");
        labelCircle.classList.toggle("on", !on);
        labelCorner.classList.toggle("on", on);
      }

      function readFileAsImage(file) {
        return new Promise((resolve, reject) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
          img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("That photo could not be opened. Please try a different image.")); };
          img.src = url;
        });
      }

      // center-crop cover
      function drawCover(img, dx, dy, dw, dh) {
        const iw = img.naturalWidth || img.width;
        const ih = img.naturalHeight || img.height;

        const scale = Math.max(dw / iw, dh / ih);
        const sw = dw / scale;
        const sh = dh / scale;

        const sx = (iw - sw) / 2;
        const sy = (ih - sh) / 2;

        ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
      }

      async function render() {
        setError("");
        elDownload.disabled = true;
        ctx.clearRect(0, 0, SIZE, SIZE);

        if (!userImg) {
          // Show just the background + overlay as a nicer empty-state preview
          try {
            const bg = await loadImage("bg.jpg");
            drawCover(bg, 0, 0, SIZE, SIZE);

            const overlaySrc = getMode() === "circle" ? "circle.png" : "corner.jpg";
            const overlay = await loadImage(overlaySrc);
            ctx.drawImage(overlay, 0, 0, SIZE, SIZE);

            const logo = await loadImage("logo.png");
            const pad = 28;
            const w = 240;
            const h = (logo.naturalHeight / logo.naturalWidth) * w;
            ctx.globalAlpha = 0.95;
            ctx.drawImage(logo, SIZE - w - pad, SIZE - h - pad, w, h);
            ctx.globalAlpha = 1;

            setStatus("Upload a photo to personalize it.");
          } catch {
            setStatus("Upload a photo to see a preview.");
          }
          return;
        }

        try {
          // 1) background
          const bg = await loadImage("bg.jpg");
          drawCover(bg, 0, 0, SIZE, SIZE);

          // 2) user photo (on top of background)
          drawCover(userImg, 0, 0, SIZE, SIZE);

          // 3) frame overlay
          const overlaySrc = getMode() === "circle" ? "circle.png" : "corner.jpg";
          const overlay = await loadImage(overlaySrc);
          ctx.drawImage(overlay, 0, 0, SIZE, SIZE);

          // 4) corner logo (required)
          const logo = await loadImage("logo.png");
          const pad = 28;
          const logoW = 240; // resize here
          const logoH = (logo.naturalHeight / logo.naturalWidth) * logoW;

          ctx.globalAlpha = 0.95;
          ctx.drawImage(logo, SIZE - logoW - pad, SIZE - logoH - pad, logoW, logoH);
          ctx.globalAlpha = 1;

          // export
          canvas.toBlob((blob) => {
            if (!blob) { setError("PNG export failed in this browser."); return; }
            if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
            lastBlobUrl = URL.createObjectURL(blob);
            elDownload.disabled = false;
            setStatus("Ready to download.");
          }, "image/png");

        } catch (e) {
          setError(e.message || String(e));
        }
      }

      function download() {
        if (!lastBlobUrl) return;
        const a = document.createElement("a");
        a.href = lastBlobUrl;
        a.download = `wessels-${getMode()}-frame.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      elFile.addEventListener("change", async (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        try {
          userImg = await readFileAsImage(f);
          await render();
        } catch (e) {
          userImg = null;
          setError(e.message || String(e));
        }
      });

      modeSwitch.addEventListener("click", async () => {
        setMode(getMode() === "circle" ? "corner" : "circle");
        await render();
      });

      elDownload.addEventListener("click", download);

      // init
      setMode("circle");
      setStatus("Upload a photo to see a preview.");
      render();
    })();
  </script>
</body>
</html>
