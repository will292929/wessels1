<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile Frame Generator</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #0b1020; color: #fff; }
    .wrap { max-width: 820px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; }
    h1 { margin: 0 0 10px; font-size: 18px; font-weight: 700; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; }
    .left { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .small { font-size: 13px; opacity: 0.85; line-height: 1.35; }
    .error { font-size: 13px; color: #ffb4b4; white-space: pre-wrap; margin-top: 10px; }
    canvas { width: 100%; max-width: 560px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); }

    input[type="file"] { color: #fff; }
    select { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.18); border-radius: 10px; padding: 10px 12px; }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 650;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    code { opacity: 0.95; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Profile Frame Generator</h1>

      <div class="row">
        <div class="left">
          <div>
            <div class="small">Upload photo</div>
            <input id="file" type="file" accept="image/*" />
          </div>

          <div>
            <div class="small">Mode</div>
            <select id="mode">
              <option value="circle">Circle (circle.png)</option>
              <option value="corner">Corner (corner.jpg)</option>
            </select>
          </div>
        </div>

        <button id="download" class="btn" disabled>Download PNG</button>
      </div>

      <div class="small" style="margin-top: 12px;">
        Keep these in the same folder as this page:
        <code>circle.png</code>, <code>corner.jpg</code>.
        Optional: <code>logo.png</code>.
      </div>

      <div id="status" class="small" style="margin-top: 10px;"></div>
      <div id="err" class="error"></div>
    </div>

    <div class="card">
      <div class="small" style="margin-bottom: 10px;">Preview</div>
      <canvas id="c" width="1080" height="1080"></canvas>
    </div>
  </div>

  <script>
    (() => {
      const SIZE = 1080;

      const elFile = document.getElementById("file");
      const elMode = document.getElementById("mode");
      const elDownload = document.getElementById("download");
      const elStatus = document.getElementById("status");
      const elErr = document.getElementById("err");

      const canvas = document.getElementById("c");
      const ctx = canvas.getContext("2d");

      let userImg = null;
      let lastBlobUrl = null;

      const setError = (msg) => (elErr.textContent = msg || "");
      const setStatus = (msg) => (elStatus.textContent = msg || "");
      const getMode = () => elMode.value;

      function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => resolve(img);
          img.onerror = () =>
            reject(new Error(`Failed to load "${src}". Make sure you're running via http(s), not file://`));
          img.src = src;
        });
      }

      function readFileAsImage(file) {
        return new Promise((resolve, reject) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
          img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("Could not read uploaded image.")); };
          img.src = url;
        });
      }

      function drawCover(img, dx, dy, dw, dh) {
        const iw = img.naturalWidth || img.width;
        const ih = img.naturalHeight || img.height;

        const scale = Math.max(dw / iw, dh / ih);
        const sw = dw / scale;
        const sh = dh / scale;

        const sx = (iw - sw) / 2;
        const sy = (ih - sh) / 2;

        ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
      }

      async function render() {
        setError("");
        elDownload.disabled = true;

        ctx.clearRect(0, 0, SIZE, SIZE);

        if (!userImg) {
          setStatus(`Select a mode and upload a photo.`);
          return;
        }

        try {
          // base photo
          drawCover(userImg, 0, 0, SIZE, SIZE);

          // overlay
          const overlaySrc = getMode() === "circle" ? "circle.png" : "corner.jpg";
          const overlay = await loadImage(overlaySrc);
          ctx.drawImage(overlay, 0, 0, SIZE, SIZE);

          // optional logo (silent if missing)
          try {
            const logo = await loadImage("logo.png");
            const pad = 28;
            const maxW = 240;
            const scale = Math.min(1, maxW / (logo.naturalWidth || logo.width));
            const w = (logo.naturalWidth || logo.width) * scale;
            const h = (logo.naturalHeight || logo.height) * scale;
            ctx.globalAlpha = 0.95;
            ctx.drawImage(logo, SIZE - w - pad, SIZE - h - pad, w, h);
            ctx.globalAlpha = 1;
          } catch (_) {}

          canvas.toBlob((blob) => {
            if (!blob) { setError("PNG export failed (browser blocked)."); return; }
            if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
            lastBlobUrl = URL.createObjectURL(blob);
            elDownload.disabled = false;
            setStatus(`Ready: ${getMode()} mode.`);
          }, "image/png");
        } catch (e) {
          setError(e.message || String(e));
        }
      }

      function download() {
        if (!lastBlobUrl) return;
        const a = document.createElement("a");
        a.href = lastBlobUrl;
        a.download = `wessels-${getMode()}-frame.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      elFile.addEventListener("change", async (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        try {
          userImg = await readFileAsImage(f);
          await render();
        } catch (e) {
          userImg = null;
          setError(e.message || String(e));
        }
      });

      elMode.addEventListener("change", render);
      elDownload.addEventListener("click", download);

      setStatus("Select a mode and upload a photo.");
    })();
  </script>
</body>
</html>
