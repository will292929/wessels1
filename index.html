<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overlay Logo</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 2rem; }
    .preview { margin-top: 1rem; }
    canvas { max-width:100%; border: 1px solid #ddd; }
    label { display:inline-block; margin-right: 1rem; }
  </style>
</head>
<body>
  <h1>Upload photo → get logo overlay</h1>

  <label>
    Photo:
    <input id="photoInput" type="file" accept="image/*">
  </label>

  <label>
    Logo (optional — defaults to repo logo):
    <input id="logoInput" type="file" accept="image/*">
  </label>

  <div>
    <label>
      Position:
      <select id="position">
        <option value="top-left">Top left</option>
        <option value="top-right">Top right</option>
        <option value="bottom-left">Bottom left</option>
        <option value="bottom-right" selected>Bottom right</option>
        <option value="center">Center</option>
      </select>
    </label>

    <label>
      Scale (logo relative to min(photo_width,photo_height)):
      <input id="scale" type="range" min="0.05" max="0.4" step="0.01" value="0.12">
      <span id="scaleVal">12%</span>
    </label>
  </div>

  <div class="preview">
    <canvas id="canvas"></canvas>
  </div>

  <div style="margin-top:1rem;">
    <button id="downloadBtn" disabled>Download PNG</button>
  </div>

  <script>
    const photoInput = document.getElementById('photoInput');
    const logoInput = document.getElementById('logoInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {alpha: true});
    const positionSelect = document.getElementById('position');
    const scaleInput = document.getElementById('scale');
    const scaleVal = document.getElementById('scaleVal');
    const downloadBtn = document.getElementById('downloadBtn');

    // Default logo (you can change to the path of your repo's logo)
    const defaultLogoUrl = 'logo.png'; // place logo.png in repo root or change path

    function readImageFile(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        const reader = new FileReader();
        reader.onload = (e) => { img.src = e.target.result; };
        reader.onerror = () => reject(new Error('File read error'));
        reader.readAsDataURL(file);
      });
    }

    async function loadImageFromUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image: ' + url));
        img.src = url;
      });
    }

    async function composite(photoImg, logoImg) {
      const devicePixelRatio = window.devicePixelRatio || 1;
      const w = photoImg.naturalWidth;
      const h = photoImg.naturalHeight;
      canvas.width = Math.round(w * devicePixelRatio);
      canvas.height = Math.round(h * devicePixelRatio);
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      ctx.clearRect(0,0,w,h);

      // Draw photo
      ctx.drawImage(photoImg, 0, 0, w, h);

      // Compute logo size
      const scale = parseFloat(scaleInput.value); // fraction of min(w,h)
      const minDim = Math.min(w, h);
      const logoTargetWidth = Math.round(minDim * scale);
      const logoAspect = logoImg.naturalWidth / logoImg.naturalHeight;
      const logoTargetHeight = Math.round(logoTargetWidth / logoAspect);

      // Position
      const margin = Math.round(minDim * 0.03);
      let x = 0, y = 0;
      switch(positionSelect.value) {
        case 'top-left': x = margin; y = margin; break;
        case 'top-right': x = w - logoTargetWidth - margin; y = margin; break;
        case 'bottom-left': x = margin; y = h - logoTargetHeight - margin; break;
        case 'bottom-right': x = w - logoTargetWidth - margin; y = h - logoTargetHeight - margin; break;
        case 'center': x = Math.round((w - logoTargetWidth) / 2); y = Math.round((h - logoTargetHeight) / 2); break;
      }

      ctx.drawImage(logoImg, x, y, logoTargetWidth, logoTargetHeight);
      downloadBtn.disabled = false;
    }

    async function handle() {
      if (!photoInput.files || photoInput.files.length === 0) return;
      const photoFile = photoInput.files[0];
      // Basic file validation
      if (!photoFile.type.startsWith('image/')) { alert('Please upload an image file.'); return; }
      const photoImg = await readImageFile(photoFile);

      let logoImg;
      if (logoInput.files && logoInput.files.length > 0) {
        logoImg = await readImageFile(logoInput.files[0]);
      } else {
        // fallback to repo default logo file
        try {
          logoImg = await loadImageFromUrl(defaultLogoUrl);
        } catch (e) {
          alert('Default logo not found. Upload a logo or add logo.png to the repo.');
          return;
        }
      }

      await composite(photoImg, logoImg);
    }

    photoInput.addEventListener('change', handle);
    logoInput.addEventListener('change', handle);
    positionSelect.addEventListener('change', handle);
    scaleInput.addEventListener('input', () => {
      scaleVal.textContent = Math.round(parseFloat(scaleInput.value) * 100) + '%';
    });
    scaleInput.addEventListener('change', handle);

    downloadBtn.addEventListener('click', () => {
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'photo-with-logo.png';
      a.click();
    });

    // Attempt to warm-load default logo (so user sees errors early)
    (async () => {
      try { await loadImageFromUrl(defaultLogoUrl); } catch (e) { /* ignore */ }
    })();
  </script>
</body>
</html>
